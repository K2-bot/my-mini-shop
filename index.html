<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>My Super Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --button-color: var(--tg-theme-button-color, #3390ec);
            --button-text: var(--tg-theme-button-text-color, #fff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; padding-bottom: 100px; }
        
        /* Product Card Design */
        .product-card { display: flex; background: var(--secondary-bg); border-radius: 12px; padding: 10px; margin-bottom: 12px; gap: 12px; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .product-img { width: 70px; height: 70px; background-color: #ddd; border-radius: 8px; object-fit: cover; }
        .info { flex: 1; }
        .title { font-weight: 600; font-size: 15px; margin-bottom: 4px; }
        .specs { font-size: 12px; opacity: 0.7; margin-bottom: 4px; display: block; }
        .price { font-weight: bold; color: #2ecc71; font-size: 14px; }
        
        /* Buttons */
        .btn-add { background-color: var(--button-color); color: var(--button-text); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 13px; }
        .qty-control { display: flex; align-items: center; gap: 10px; display: none; }
        .qty-btn { background: #ddd; color: #000; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; }

        /* Checkout Form */
        #checkout-section { display: none; margin-top: 25px; border-top: 1px solid #ddd; padding-top: 20px; }
        input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; background-color: var(--bg-color); color: var(--text-color); }
        .form-title { font-weight: bold; margin-bottom: 10px; display: block; font-size: 16px; }
    </style>
</head>
<body>

    <h3 style="margin-top: 0;">üõçÔ∏è Available Products</h3>
    <div id="loading">Loading products...</div>
    <div id="product-list"></div>

    <div id="checkout-section">
        <label class="form-title">üìù ·Äï·Ä≠·ÄØ·Ä∑·ÄÜ·Ä±·Ä¨·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·Äú·Ä≠·Äï·Ä∫·ÄÖ·Ä¨·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´</label>
        <input type="tel" id="user-phone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫ (09xxxxxxxxx)">
        <textarea id="user-address" rows="2" placeholder="·Ä°·Ä≠·Äô·Ä∫·Ä°·Äô·Äæ·Äê·Ä∫·Åä ·Äú·Äô·Ä∫·Ä∏·Åä ·Äô·Äº·Ä≠·ÄØ·Ä∑·Äî·Äö·Ä∫"></textarea>
    </div>

    <script>
        // ·ÅÅ·Åã Config (·Äô·Ä≠·Äê·Ä∫·ÄÜ·ÄΩ·Ä±·Äï·Ä±·Ä∏·Äë·Ä¨·Ä∏·Äû·Ä±·Ä¨ Key ·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·Äë·Ää·Ä∑·Ä∫·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äë·Ä¨·Ä∏·Äï·Ä´·Äû·Ää·Ä∫)
        const SUPABASE_URL = 'https://lqqlapefokawylbzuhvj.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcWxhcGVmb2thd3lsYnp1aHZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MjYwODUsImV4cCI6MjA4MDUwMjA4NX0.LKypQGK6hvJvxsD9w-qPZVuiw7NF3xR8g1D2LvI8eH0';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        tg.expand(); // ·Äô·Äª·ÄÄ·Ä∫·Äî·Äæ·Ä¨·Äï·Äº·ÄÑ·Ä∫·Ä°·Äï·Äº·Ää·Ä∑·Ä∫

        let cart = {}; // { id: quantity }
        let productsMap = {}; // id -> product data (·Äà·Ä±·Ä∏·Äê·ÄΩ·ÄÄ·Ä∫·Äñ·Ä≠·ÄØ·Ä∑)

        // ·ÅÇ·Åã ·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        async function fetchProducts() {
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .eq('is_active', true)
                .order('created_at', { ascending: false });

            document.getElementById('loading').style.display = 'none';
            const container = document.getElementById('product-list');

            if (data) {
                data.forEach(product => {
                    productsMap[product.id] = product; // ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äë·Ä¨·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äô·Äö·Ä∫

                    // JSONB Data ·ÄÄ·Ä≠·ÄØ ·ÄÅ·ÄΩ·Ä≤·ÄÅ·Äº·Ä¨·Ä∏·Äï·Äº·Äû·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
                    let specText = [];
                    const s = product.specifications || {};
                    
                    if (s.brand) specText.push(s.brand);
                    if (s.author) specText.push("‚úçÔ∏è " + s.author);
                    if (s.expire_date) specText.push("‚è≥ " + s.expire_date);
                    if (product.is_preorder) specText.push("üïí Pre-order: " + (product.waiting_time || ''));

                    // Image Handling
                    const imgUrl = (product.images && product.images.length > 0) ? product.images[0] : 'https://placehold.co/80x80?text=No+Img';

                    const item = document.createElement('div');
                    item.className = 'product-card';
                    item.innerHTML = `
                        <img src="${imgUrl}" class="product-img">
                        <div class="info">
                            <div class="title">${product.name}</div>
                            <span class="specs">${specText.join(' ‚Ä¢ ')}</span>
                            <div class="price">${product.base_price.toLocaleString()} Ks</div>
                        </div>
                        <div class="actions">
                            <button class="btn-add" id="btn-add-${product.id}" onclick="updateCart('${product.id}', 1)">Add</button>
                            <div class="qty-control" id="qty-control-${product.id}">
                                <button class="qty-btn" onclick="updateCart('${product.id}', -1)">-</button>
                                <span id="qty-${product.id}" style="font-weight:bold">0</span>
                                <button class="qty-btn" onclick="updateCart('${product.id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            } else {
                container.innerHTML = "<p>·Äï·ÄÖ·Äπ·ÄÖ·Ää·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äô·Äõ·Äæ·Ä≠·Äû·Ä±·Ä∏·Äï·Ä´·Åã</p>";
            }
        }

        // ·ÅÉ·Åã ·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏ Logic
        function updateCart(id, change) {
            if (!cart[id]) cart[id] = 0;
            cart[id] += change;

            if (cart[id] <= 0) {
                delete cart[id];
                document.getElementById(`btn-add-${id}`).style.display = 'block';
                document.getElementById(`qty-control-${id}`).style.display = 'none';
            } else {
                document.getElementById(`btn-add-${id}`).style.display = 'none';
                document.getElementById(`qty-control-${id}`).style.display = 'flex';
                document.getElementById(`qty-${id}`).innerText = cart[id];
            }

            updateMainButton();
        }

        // ·ÅÑ·Åã Telegram Button ·Äî·Äæ·ÄÑ·Ä∑·Ä∫ Checkout Form ·Äë·Ä≠·Äî·Ä∫·Ä∏·ÄÅ·Äª·ÄØ·Äï·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        function updateMainButton() {
            const totalItems = Object.values(cart).reduce((a, b) => a + b, 0);
            const formSection = document.getElementById('checkout-section');
            
            if (totalItems > 0) {
                // ·Äà·Ä±·Ä∏·Äù·Äö·Ä∫·Äî·Ä±·Äõ·ÄÑ·Ä∫ Form ·Äï·Äº·Äô·Äö·Ä∫
                formSection.style.display = 'block';
                
                // ·ÄÖ·ÄØ·ÄÖ·ÄØ·Äï·Ä±·Ä´·ÄÑ·Ä∫·Ä∏·ÄÑ·ÄΩ·Ä± ·Äê·ÄΩ·ÄÄ·Ä∫·Äô·Äö·Ä∫
                let totalPrice = 0;
                for (const [id, qty] of Object.entries(cart)) {
                    totalPrice += productsMap[id].base_price * qty;
                }

                tg.MainButton.setText(`Order Now (${totalPrice.toLocaleString()} Ks)`);
                tg.MainButton.show();
            } else {
                formSection.style.display = 'none';
                tg.MainButton.hide();
            }
        }

        // ·ÅÖ·Åã Order ·Äê·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ (Bot ·Äû·Ä≠·ÄØ·Ä∑ Data ·Äï·Ä≠·ÄØ·Ä∑·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏)
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            const phone = document.getElementById('user-phone').value;
            const address = document.getElementById('user-address').value;

            if (!phone || !address) {
                tg.showPopup({ title: '·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·ÄÅ·Äª·ÄÄ·Ä∫', message: '·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·Äú·Ä≠·Äï·Ä∫·ÄÖ·Ä¨ ·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä±·Ä∏·Äï·Ä´·ÄÅ·ÄÑ·Ä∫·Äó·Äª·Ä¨·Åã' });
                return;
            }

            // Bot ·ÄÜ·ÄÆ·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∑·Ä∫ Data
            const payload = {
                cart: Object.keys(cart).map(key => ({ id: key, quantity: cart[key] })),
                user_info: { phone: phone, address: address }
            };

            tg.sendData(JSON.stringify(payload));
        });

        // Start
        fetchProducts();
    </script>
</body>
</html>
